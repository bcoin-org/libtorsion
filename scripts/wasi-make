#!/bin/sh

# wasi-make - wasi wrapper for makefiles
# Copyright (c) 2020, Christopher Jeffrey (MIT License).
# https://github.com/bcoin-org/libtorsion

if test -n "$WASI"; then
  WASI=`cd "$WASI" && pwd`
elif test -d /opt/wasi-sdk; then
  WASI=/opt/wasi-sdk
elif test -d /opt/local/wasi-sdk; then
  WASI=/opt/local/wasi-sdk
else
  echo 'WASI SDK not found!' >& 2
  exit 1
fi

MAKE="$1"

shift

while echo x"$1" | grep -q '^x-'; do
  if test x"$1" = x'-f'; then
    MAKE="$MAKE $1 $2"
    shift
    shift
  else
    MAKE="$MAKE $1"
    shift
  fi
done

exec $MAKE CC=$WASI/bin/clang            \
           AR=$WASI/bin/llvm-ar          \
           RANLIB=$WASI/bin/llvm-ranlib  \
           ARFLAGS=cr                    \
           "$@"
